<!DOCTYPE html>


<html lang="en-us" data-theme="">
<head>
    
        
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer-when-downgrade">

<title>üîç Performing Sequence Labelling using CRF in Python - ayeung.dev</title>

<meta name="description" content="In natural language processing, it is a common task to extract words or phrases of particular types from a given sentence or paragraph. For example, when performing analysis of a corpus of news articles, we may want to know which countries are mentioned in the articles, and how many articles are related to each of these countries.">





<link rel="icon" type="image/x-icon" href="https://ayeung.dev/favicon.ico">
<link rel="apple-touch-icon-precomposed" href="https://ayeung.dev/favicon.png">








    



<style>
  body {
    visibility: hidden;
    opacity: 0;
  }
</style>

<noscript>
  <style>
    body {
      visibility: visible;
      opacity: 1;
    }
  </style>
</noscript>




    





    
    
        
    
    

    
        <link rel="stylesheet" href="/css/style.min.44f8240afd8df81b52565c4119ac5ae247776c77fc6d7ccf6e101a6c98abfa7a.css" integrity="sha256-RPgkCv2N&#43;BtSVlxBGaxa4kd3bHf8bXzPbhAabJir&#43;no=">
    





    





    
    
        
    
    

    
        <link rel="stylesheet" href="/css/style.min.c4c04b3ef88e3d619ad4c7ee5e03048422bc55c4fefdc1f07657c1133670aa22.css" integrity="sha256-xMBLPviOPWGa1MfuXgMEhCK8VcT&#43;/cHwdlfBEzZwqiI=">
    





    





    
    
        
    
    

    
        <link rel="stylesheet" href="/css/style.min.21c5d8fe0a79d623b0adc1ce4bd4f6dd2c05cd939c9aaaa966ba7186b1464f4d.css" integrity="sha256-IcXY/gp51iOwrcHOS9T23SwFzZOcmqqpZrpxhrFGT00=">
    







    
    
      
    

    
      
        <link rel="stylesheet" href="/css/style.min.089e7f1457df6ef7e8440d02f1c3ec62874fa6345ffbba7b7b6862fa52fd86f6.css" integrity="sha256-CJ5/FFffbvfoRA0C8cPsYodPpjRf&#43;7p7e2hi&#43;lL9hvY=" crossorigin="anonymous">
      
    






    

    





    
    
        
    
    

    
        <script src="/js/script.min.08f04d96386c73c9bf4d160333f8f448c05a6e01c06770542ee0e013954ce930.js" type="text/javascript" charset="utf-8" integrity="sha256-CPBNljhsc8m/TRYDM/j0SMBabgHAZ3BULuDgE5VM6TA="></script>
    



















    
</head>
<body>
    <a class="skip-main" href="#main">Skip to main content</a>
    <div class="container">
        <header class="common-header">
            
                <div class="header-top">
    <div class="header-top-left">
        <h1 class="site-title noselect">
    <a href="/">ayeung.dev</a>
</h1>

        







    
        <div class="theme-switcher">
            <span class="inline-svg">

    


    
    
    
    
    

    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-sun-high"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14.828 14.828a4 4 0 1 0 -5.656 -5.656a4 4 0 0 0 5.656 5.656z" /><path d="M6.343 17.657l-1.414 1.414" /><path d="M6.343 6.343l-1.414 -1.414" /><path d="M17.657 6.343l1.414 -1.414" /><path d="M17.657 17.657l1.414 1.414" /><path d="M4 12h-2" /><path d="M12 4v-2" /><path d="M20 12h2" /><path d="M12 20v2" /></svg>


</span>

        </div>
    

    <script>
        const STORAGE_KEY = 'user-color-scheme'
        const defaultTheme = "light"

        let currentTheme
        let switchButton
        let autoDefinedScheme = window.matchMedia('(prefers-color-scheme: dark)')

        function switchTheme(e) {
            currentTheme = (currentTheme === 'dark') ? 'light' : 'dark';
            if (localStorage) localStorage.setItem(STORAGE_KEY, currentTheme);
            document.documentElement.setAttribute('data-theme', currentTheme);
            changeGiscusTheme(currentTheme);
            document.body.dispatchEvent(new CustomEvent(currentTheme + "-theme-set"));
        }

        const autoChangeScheme = e => {
            currentTheme = e.matches ? 'dark' : 'light'
            document.documentElement.setAttribute('data-theme', currentTheme);
            changeGiscusTheme(currentTheme);
            document.body.dispatchEvent(new CustomEvent(currentTheme + "-theme-set"));
        }

        document.addEventListener('DOMContentLoaded', function () {
            switchButton = document.querySelector('.theme-switcher')
            currentTheme = detectCurrentScheme()

            if (currentTheme === 'auto') {
                autoChangeScheme(autoDefinedScheme);
                autoDefinedScheme.addListener(autoChangeScheme);
            } else {
                document.documentElement.setAttribute('data-theme', currentTheme)
            }

            if (switchButton) {
                switchButton.addEventListener('click', switchTheme, false)
            }

            showContent();
        })

        function detectCurrentScheme() {
            if (localStorage !== null && localStorage.getItem(STORAGE_KEY)) {
                return localStorage.getItem(STORAGE_KEY)
            }
            if (defaultTheme) {
                return defaultTheme
            }
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function showContent() {
            document.body.style.visibility = 'visible';
            document.body.style.opacity = 1;
        }

        function changeGiscusTheme (theme) {
            function sendMessage(message) {
              const iframe = document.querySelector('iframe.giscus-frame');
              if (!iframe) return;
              iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
            }

            sendMessage({
              setConfig: {
                theme: theme
              }
            });
        }
    </script>


        <ul class="social-icons noselect">


    
        <li>
            <a href="https://github.com/albertauyeung" title="Github" rel="me">
            <span class="inline-svg">

    


    
    
    
    
    

    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-github"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" /></svg>


</span>

            </a>
        </li>
    

    
        <li>
            <a href="https://www.linkedin.com/in/albert-au-yeung/" title="Linkedin" rel="me">
            <span class="inline-svg">

    


    
    
    
    
    

    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-linkedin"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z" /><path d="M8 11l0 5" /><path d="M8 8l0 .01" /><path d="M12 16l0 -5" /><path d="M16 16v-3a2 2 0 0 0 -4 0" /></svg>


</span>

            </a>
        </li>
    






    <li>
            <a href="/index.xml" title="RSS" rel="me">
            <span class="inline-svg">

    


    
    
    
    
    

    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-rss"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 19m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" /><path d="M4 4a16 16 0 0 1 16 16" /><path d="M4 11a9 9 0 0 1 9 9" /></svg>


</span>

            </a>
        </li>
    

</ul>

    </div>
    <div class="header-top-right">

    </div>
</div>


    <nav class="noselect">
        
        
        <a class="" href="https://ayeung.dev/" title="">Home</a>
        
        <a class="" href="https://ayeung.dev/about/" title="">About</a>
        
        <a class="" href="https://ayeung.dev/tags/" title="">Tags</a>
        
        <a class="" href="https://ayeung.dev/quotes/" title="">Quotes</a>
        
        <a class="" href="https://ayeung.dev/posts/" title="">Archive</a>
        
    </nav>



<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$','$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };

  window.addEventListener('load', (event) => {
      document.querySelectorAll("mjx-container").forEach(function(x){
        x.parentElement.classList += 'has-jax'})
    });

</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>





            
        </header>
        <main id="main" tabindex="-1">
            
    

    <article class="post h-entry">
        <div class="post-header">
            <header>
                <h1 class="p-name post-title">üîç Performing Sequence Labelling using CRF in Python</h1>
                

            </header>
            



<div class="post-info noselect">
    
        <div class="post-date dt-published">
            <time datetime="2017-06-17">2017-06-17</time>
            
        </div>
    

    <a class="post-hidden-url u-url" href="/2017/06/17/python-sequence-labelling-with-crf.html">/2017/06/17/python-sequence-labelling-with-crf.html</a>
    <a href="https://ayeung.dev/" class="p-name p-author post-hidden-author h-card" rel="me">map[location:Dublin, Ireland name:Albert Au Yeung]</a>


    <div class="post-taxonomies">
        
        
            <ul class="post-tags">
                
                    
                    <li><a href="/tags/python/">#Python</a></li>
                
                    
                    <li><a href="/tags/machine-learning/">#Machine Learning</a></li>
                
                    
                    <li><a href="/tags/sequence-labelling/">#Sequence Labelling</a></li>
                
                    
                    <li><a href="/tags/crf/">#Crf</a></li>
                
            </ul>
        
        
    </div>
</div>

        </div>
        

  
  
    
  






<script>
  var toc = document.querySelector(".toc");
  if (toc) {
    toc.addEventListener("click", function () {
      if (event.target.tagName !== "A") {
        event.preventDefault();
        if (this.open) {
          this.open = false;
          this.classList.remove("expanded");
        } else {
          this.open = true;
          this.classList.add("expanded");
        }
      }
    });
  }
</script>

        <div class="content e-content">
            <p>In <a href="https://en.wikipedia.org/wiki/Natural_language_processing">natural language processing</a>, it is a common task to <strong>extract words or phrases of particular types</strong> from a given sentence or paragraph. For example, when performing analysis of a corpus of news articles, we may want to know which countries are mentioned in the articles, and how many articles are related to each of these countries.</p>
<h2 id="sequence-labelling-in-nlp" >
<div>
    <a href="#sequence-labelling-in-nlp">
        #
    </a>
    Sequence Labelling in NLP
</div>
</h2>
<p>This is actually a special case of <strong>sequence labelling</strong> in NLP (others include <a href="https://en.wikipedia.org/wiki/Part-of-speech_tagging">POS tagging</a> and <a href="https://en.wikipedia.org/wiki/Shallow_parsing">Chunking</a>), in which the goal is to assign a label to each member in the sequence. In the case of identifying country names, we would like to assign a &lsquo;<em>country</em>&rsquo; label to words that form part of a country name, and a &lsquo;<em>irrelevant</em>&rsquo; label to all other words. For example, the following is a sentence broken down into tokens, and its desired output after the sequence labelling process:</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff5c57">input</span> <span style="color:#ff6ac1">=</span> [<span style="color:#5af78e">&#34;Paris&#34;</span>, <span style="color:#5af78e">&#34;is&#34;</span>, <span style="color:#5af78e">&#34;the&#34;</span>, <span style="color:#5af78e">&#34;capital&#34;</span>, <span style="color:#5af78e">&#34;of&#34;</span>, <span style="color:#5af78e">&#34;France&#34;</span>]
</span></span><span style="display:flex;"><span>output <span style="color:#ff6ac1">=</span> [<span style="color:#5af78e">&#34;I&#34;</span>, <span style="color:#5af78e">&#34;I&#34;</span>, <span style="color:#5af78e">&#34;I&#34;</span>, <span style="color:#5af78e">&#34;I&#34;</span>, <span style="color:#5af78e">&#34;I&#34;</span>, <span style="color:#5af78e">&#34;C&#34;</span>]
</span></span></code></pre></div><p>where <em>I</em> means that the token of that position is an irrelevant word, and <em>C</em> means that the token of that position is a word that form part of a country name.</p>
<h2 id="methods-of-sequence-labelling" >
<div>
    <a href="#methods-of-sequence-labelling">
        #
    </a>
    Methods of Sequence Labelling
</div>
</h2>
<p>A simple, though sometimes quite useful, approach is to prepare a <strong>dictionary</strong> of country names, and look for these names in each of the sentences in the corpus. However, this method relies heavily on the comprehensiveness of the dictionary. While there is a limited number of countries, in other cases such as city names the number of possible entries in the dictionary can be huge. Even for countries, many countries may be referred to using different sequence of characters in different contexts. For example, the United States of America may be referred to in an article as <em>the USA</em>, <em>the States</em>, or simply <em>America</em>.</p>
<p>In fact, a person reading a news article would usually recognise that a word or a phrase refers to a country, even when he or she has not seen the name of that country before. The reason is that there are many differnt <strong>cues</strong> in the sentence or the whole article that can be used to determine whether a word or a phrase is a country name. Take the following two sentences as examples:</p>
<ul>
<li>Kerry travels to <strong>Laos</strong>&rsquo;s capital, Vientiane, on Monday for meetings of foreign ministers from the 10-member Association of South East Asia Nations (ASEAN).</li>
<li>The Governments of <strong>Bolivia</strong> and <strong>Uruguay</strong> will strengthen ties with a customs cooperation agreement to be in force on June 15th.</li>
</ul>
<p>The first sentence implies that something called <strong>Lao</strong> has a capital, suggesting that <strong>Lao</strong> is a country. Similarly, in the second sentence we know that both <strong>Bolivia</strong> and <strong>Uruguay</strong> are countries as the news mentioned about their governments. In other words, the words around &lsquo;Lao&rsquo;, &lsquo;Bolivia&rsquo; and &lsquo;Uruguay&rsquo; provide clues as to whether they are country names.</p>
<h2 id="conditional-random-field-crf" >
<div>
    <a href="#conditional-random-field-crf">
        #
    </a>
    Conditional Random Field (CRF)
</div>
</h2>
<p>To take advantage of the surrounding context when labelling tokens in a sequence, a commonly used method is <a href="https://en.wikipedia.org/wiki/Conditional_random_field">conditional random field</a> (CRF), first proposed by <a href="http://repository.upenn.edu/cgi/viewcontent.cgi?article=1162&amp;context=cis_papers">Lafferty et al.</a> in 2001. It is  a type of probabilistic graphical model that can be used to model sequential data, such as labels of words in a sentence.</p>
<p>This article is not intended to discuss the technical details of CRF. If you are interested, you are recommended to check out one of the following tutorials which provide very good explanation of how CRF works:</p>
<ul>
<li><a href="http://homepages.inf.ed.ac.uk/csutton/publications/crftut-fnt.pdf">An Introduction to Conditional
Random Fields</a> by Charles Sutton and Andrew McCallum</li>
<li><a href="http://blog.echen.me/2012/01/03/introduction-to-conditional-random-fields/">Introduction to Conditional Random Fields</a> by Edwin Chen</li>
</ul>
<p>In CRF, we will design a set of <strong>feature functions</strong> to extract features for each word in a sentence. During model training, CRF will try to determine the weights of different feature functions that will maximise the likelihood of the labels in the training data.</p>
<h2 id="train-crf-model-in-python" >
<div>
    <a href="#train-crf-model-in-python">
        #
    </a>
    Train CRF Model in Python
</div>
</h2>
<p>One of the commonly used CRF library is <a href="http://www.chokkan.org/software/crfsuite/">CRFSuite implemented by Naoaki Okazaki</a> in C/C++. The library is already easy to use given its command line interface. A Python binding to CRFSuite, <a href="https://github.com/scrapinghub/python-crfsuite">pycrfsuite</a> is available for using the API in Python. This Python module is exactly the module used in the POS tagger in the <a href="http://www.nltk.org/">nltk module</a>.</p>
<p>To demonstrate how pysrfsuite can be used to train a linear chained CRF sequence labelling model, we will go through an example using some data for <em>named entity recognition</em>.</p>
<h3 id="named-entity-recogniton" >
<div>
    <a href="#named-entity-recogniton">
        ##
    </a>
    Named Entity Recogniton
</div>
</h3>
<p>To train a named entity recognition model, we need some labelled data. The dataset that will be used below is the <strong>Reuters-128 dataset</strong>, which is an English corpus in the NLP Interchange Format (NIF). It contains 128 economic news articles. The dataset contains information for <strong>880</strong> named entities with their position in the document and a URI of a <a href="http://wiki.dbpedia.org/">DBpedia</a> resource identifying the entity. It was created by the <a href="http://aksw.org/About.html">Agile Knowledge Engineering and Semantic Web research group at Leipzig University, Germany</a>. More details can be found in <a href="http://svn.aksw.org/papers/2014/LREC_N3NIFNERNED/public.pdf">their paper</a>.</p>
<p>In the following, we will use the XML verison of the dataset, which can be downloaded from <a href="https://github.com/AKSW/n3-collection">https://github.com/AKSW/n3-collection</a>. Below is some lines extracted from the XML data file:</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#ff6ac1">document</span> <span style="color:#57c7ff">id</span><span style="color:#ff6ac1">=</span><span style="color:#5af78e">&#34;8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#ff6ac1">documenturi</span>&gt;http://www.research.att.com/~lewis/Reuters-21578/15009&lt;/<span style="color:#ff6ac1">documenturi</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#ff6ac1">documentsource</span>&gt;Reuters-21578&lt;/<span style="color:#ff6ac1">documentsource</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#ff6ac1">textwithnamedentities</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#ff6ac1">namedentityintext</span> <span style="color:#57c7ff">uri</span><span style="color:#ff6ac1">=</span><span style="color:#5af78e">&#34;http://aksw.org/notInWiki/Home_Intensive_Care_Inc&#34;</span>&gt;Home Intensive Care Inc&lt;/<span style="color:#ff6ac1">namedentityintext</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#ff6ac1">simpletextpart</span>&gt; said it has opened a Dialysis at Home office in &lt;/<span style="color:#ff6ac1">simpletextpart</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#ff6ac1">namedentityintext</span> <span style="color:#57c7ff">uri</span><span style="color:#ff6ac1">=</span><span style="color:#5af78e">&#34;http://dbpedia.org/resource/Philadelphia&#34;</span>&gt;Philadelphia&lt;/<span style="color:#ff6ac1">namedentityintext</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#ff6ac1">simpletextpart</span>&gt;, its 12th nationwide.&lt;/<span style="color:#ff6ac1">simpletextpart</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#ff6ac1">textwithnamedentities</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#ff6ac1">document</span>&gt;
</span></span></code></pre></div><p>The XML block shown above refers to one of the documents in the dataset. The semantics is self-explanatory. The document has a sentence &lsquo;Home Intensive Care Inc said it has opened a Dialysis at Home office in Philadelphia, its 12th nationwide&rsquo;, in which <strong>Home Intensive Care Inc</strong> and <strong>Philadelphia</strong> are labelled as named entities.</p>
<h3 id="prepare-the-dataset-for-training" >
<div>
    <a href="#prepare-the-dataset-for-training">
        ##
    </a>
    Prepare the Dataset for Training
</div>
</h3>
<p>In order to prepare the dataset for training, we need to label every word (or token) in the sentences to be either <em>irrelevant</em> or part of a <em>named entity</em>. Since the data is in XML format, we can make use of <a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/">BeautifulSoup</a> to parse the file and extract the data as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff6ac1">from</span> bs4 <span style="color:#ff6ac1">import</span> BeautifulSoup <span style="color:#ff6ac1">as</span> bs
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">from</span> bs4.element <span style="color:#ff6ac1">import</span> Tag
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> codecs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Read data file and parse the XML</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">with</span> codecs<span style="color:#ff6ac1">.</span>open(<span style="color:#5af78e">&#34;reuters.xml&#34;</span>, <span style="color:#5af78e">&#34;r&#34;</span>, <span style="color:#5af78e">&#34;utf-8&#34;</span>) <span style="color:#ff6ac1">as</span> infile:
</span></span><span style="display:flex;"><span>    soup <span style="color:#ff6ac1">=</span> bs(infile, <span style="color:#5af78e">&#34;html5lib&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docs <span style="color:#ff6ac1">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">for</span> elem <span style="color:#ff6ac1">in</span> soup<span style="color:#ff6ac1">.</span>find_all(<span style="color:#5af78e">&#34;document&#34;</span>):
</span></span><span style="display:flex;"><span>    texts <span style="color:#ff6ac1">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#78787e"># Loop through each child of the element under &#34;textwithnamedentities&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">for</span> c <span style="color:#ff6ac1">in</span> elem<span style="color:#ff6ac1">.</span>find(<span style="color:#5af78e">&#34;textwithnamedentities&#34;</span>)<span style="color:#ff6ac1">.</span>children:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> <span style="color:#ff5c57">type</span>(c) <span style="color:#ff6ac1">==</span> Tag:
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">if</span> c<span style="color:#ff6ac1">.</span>name <span style="color:#ff6ac1">==</span> <span style="color:#5af78e">&#34;namedentityintext&#34;</span>:
</span></span><span style="display:flex;"><span>                label <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;N&#34;</span>  <span style="color:#78787e"># part of a named entity</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">else</span>:
</span></span><span style="display:flex;"><span>                label <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;I&#34;</span>  <span style="color:#78787e"># irrelevant word</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">for</span> w <span style="color:#ff6ac1">in</span> c<span style="color:#ff6ac1">.</span>text<span style="color:#ff6ac1">.</span>split(<span style="color:#5af78e">&#34; &#34;</span>):
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">if</span> <span style="color:#ff5c57">len</span>(w) <span style="color:#ff6ac1">&gt;</span> <span style="color:#ff9f43">0</span>:
</span></span><span style="display:flex;"><span>                    texts<span style="color:#ff6ac1">.</span>append((w, label))
</span></span><span style="display:flex;"><span>    docs<span style="color:#ff6ac1">.</span>append(texts)
</span></span></code></pre></div><p>The result will be a list of documents, each of which contains a list of (word, label) tuples. For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff6ac1">&gt;&gt;&gt;</span> doc[<span style="color:#ff9f43">0</span>][:<span style="color:#ff9f43">10</span>]
</span></span><span style="display:flex;"><span>[(<span style="color:#5af78e">&#39;Paxar&#39;</span>, <span style="color:#5af78e">&#39;N&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#5af78e">&#39;Corp&#39;</span>, <span style="color:#5af78e">&#39;N&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#5af78e">&#39;said&#39;</span>, <span style="color:#5af78e">&#39;I&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#5af78e">&#39;it&#39;</span>, <span style="color:#5af78e">&#39;I&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#5af78e">&#39;has&#39;</span>, <span style="color:#5af78e">&#39;I&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#5af78e">&#39;acquired&#39;</span>, <span style="color:#5af78e">&#39;I&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#5af78e">&#39;Thermo-Print&#39;</span>, <span style="color:#5af78e">&#39;N&#39;</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">...</span>
</span></span></code></pre></div><h3 id="generating-part-of-speech-tags" >
<div>
    <a href="#generating-part-of-speech-tags">
        ##
    </a>
    Generating Part-of-Speech Tags
</div>
</h3>
<p>To train a CRF model, we need to create features for each of the tokens in the sentences. One particularly useful feature in NLP is the <a href="https://en.wikipedia.org/wiki/Part-of-speech_tagging">part-of-speech (POS) tags</a> of the words. They indicates whether a word is a noun, a verb or an adjective. (In fact, a POS tagger is also usually a trained CRF model.)</p>
<p>We can use <a href="http://www.nltk.org/book/ch05.html">NLTK&rsquo;s POS tagger</a> to generate the POS tags for the tokens in our documents as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> nltk
</span></span><span style="display:flex;"><span>data <span style="color:#ff6ac1">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">for</span> i, doc <span style="color:#ff6ac1">in</span> <span style="color:#ff5c57">enumerate</span>(docs):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#78787e"># Obtain the list of tokens in the document</span>
</span></span><span style="display:flex;"><span>    tokens <span style="color:#ff6ac1">=</span> [t <span style="color:#ff6ac1">for</span> t, label <span style="color:#ff6ac1">in</span> doc]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#78787e"># Perform POS tagging</span>
</span></span><span style="display:flex;"><span>    tagged <span style="color:#ff6ac1">=</span> nltk<span style="color:#ff6ac1">.</span>pos_tag(tokens)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#78787e"># Take the word, POS tag, and its label</span>
</span></span><span style="display:flex;"><span>    data<span style="color:#ff6ac1">.</span>append([(w, pos, label) <span style="color:#ff6ac1">for</span> (w, label), (word, pos) <span style="color:#ff6ac1">in</span> <span style="color:#ff5c57">zip</span>(doc, tagged)])
</span></span></code></pre></div><p>The output of the above process will be a list of documents, each of which is a list of tuples with the word, its POS tag and its label:</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff6ac1">&gt;&gt;&gt;</span> data[<span style="color:#ff9f43">0</span>]
</span></span><span style="display:flex;"><span>[(<span style="color:#5af78e">&#39;Paxar&#39;</span>, <span style="color:#5af78e">&#39;NNP&#39;</span>, <span style="color:#5af78e">&#39;N&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#5af78e">&#39;Corp&#39;</span>, <span style="color:#5af78e">&#39;NNP&#39;</span>, <span style="color:#5af78e">&#39;N&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#5af78e">&#39;said&#39;</span>, <span style="color:#5af78e">&#39;VBD&#39;</span>, <span style="color:#5af78e">&#39;I&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#5af78e">&#39;it&#39;</span>, <span style="color:#5af78e">&#39;PRP&#39;</span>, <span style="color:#5af78e">&#39;I&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#5af78e">&#39;has&#39;</span>, <span style="color:#5af78e">&#39;VBZ&#39;</span>, <span style="color:#5af78e">&#39;I&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#5af78e">&#39;acquired&#39;</span>, <span style="color:#5af78e">&#39;VBN&#39;</span>, <span style="color:#5af78e">&#39;I&#39;</span>),
</span></span><span style="display:flex;"><span> (<span style="color:#5af78e">&#39;Thermo-Print&#39;</span>, <span style="color:#5af78e">&#39;NNP&#39;</span>, <span style="color:#5af78e">&#39;N&#39;</span>),
</span></span><span style="display:flex;"><span> <span style="color:#ff6ac1">...</span>
</span></span></code></pre></div><h3 id="generating-features" >
<div>
    <a href="#generating-features">
        ##
    </a>
    Generating Features
</div>
</h3>
<p>Given the POS tags, we can now continue to generate more features for each of the tokens in the dataset. The features that will be useful in the training process depends on the task at hand. Below are some of the commonly used features for a word $w$ in named entity recognition:</p>
<ul>
<li>The word $w$ itself (converted to lowercase for normalisation)</li>
<li>The prefix/suffix of $w$ (e.g. -ion)</li>
<li>The words surrounding $w$, such as the previous and the next word</li>
<li>Whether $w$ is in uppercase or lowercase</li>
<li>Whether $w$ is a number, or contains digits</li>
<li>The POS tag of $w$, and those of the surrounding words</li>
<li>Whether $w$ is or contains a special character (e.g. hypen, dollar sign)</li>
</ul>
<p>Below is a function for generating features for our documents. It takes a doc (in the form of a listof tuples as shown above), and an index (the $i$th document), and return the documents with features extracted. (A similar example can be found in <a href="https://github.com/scrapinghub/python-crfsuite/blob/master/examples/CoNLL%202002.ipynb">the repository of pyscrfsuite</a>.)</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff6ac1">def</span> <span style="color:#57c7ff">word2features</span>(doc, i):
</span></span><span style="display:flex;"><span>    word <span style="color:#ff6ac1">=</span> doc[i][<span style="color:#ff9f43">0</span>]
</span></span><span style="display:flex;"><span>    postag <span style="color:#ff6ac1">=</span> doc[i][<span style="color:#ff9f43">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#78787e"># Common features for all words</span>
</span></span><span style="display:flex;"><span>    features <span style="color:#ff6ac1">=</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;bias&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;word.lower=&#39;</span> <span style="color:#ff6ac1">+</span> word<span style="color:#ff6ac1">.</span>lower(),
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;word[-3:]=&#39;</span> <span style="color:#ff6ac1">+</span> word[<span style="color:#ff6ac1">-</span><span style="color:#ff9f43">3</span>:],
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;word[-2:]=&#39;</span> <span style="color:#ff6ac1">+</span> word[<span style="color:#ff6ac1">-</span><span style="color:#ff9f43">2</span>:],
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;word.isupper=</span><span style="color:#5af78e">%s</span><span style="color:#5af78e">&#39;</span> <span style="color:#ff6ac1">%</span> word<span style="color:#ff6ac1">.</span>isupper(),
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;word.istitle=</span><span style="color:#5af78e">%s</span><span style="color:#5af78e">&#39;</span> <span style="color:#ff6ac1">%</span> word<span style="color:#ff6ac1">.</span>istitle(),
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;word.isdigit=</span><span style="color:#5af78e">%s</span><span style="color:#5af78e">&#39;</span> <span style="color:#ff6ac1">%</span> word<span style="color:#ff6ac1">.</span>isdigit(),
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;postag=&#39;</span> <span style="color:#ff6ac1">+</span> postag
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#78787e"># Features for words that are not</span>
</span></span><span style="display:flex;"><span>    <span style="color:#78787e"># at the beginning of a document</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">if</span> i <span style="color:#ff6ac1">&gt;</span> <span style="color:#ff9f43">0</span>:
</span></span><span style="display:flex;"><span>        word1 <span style="color:#ff6ac1">=</span> doc[i<span style="color:#ff6ac1">-</span><span style="color:#ff9f43">1</span>][<span style="color:#ff9f43">0</span>]
</span></span><span style="display:flex;"><span>        postag1 <span style="color:#ff6ac1">=</span> doc[i<span style="color:#ff6ac1">-</span><span style="color:#ff9f43">1</span>][<span style="color:#ff9f43">1</span>]
</span></span><span style="display:flex;"><span>        features<span style="color:#ff6ac1">.</span>extend([
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;-1:word.lower=&#39;</span> <span style="color:#ff6ac1">+</span> word1<span style="color:#ff6ac1">.</span>lower(),
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;-1:word.istitle=</span><span style="color:#5af78e">%s</span><span style="color:#5af78e">&#39;</span> <span style="color:#ff6ac1">%</span> word1<span style="color:#ff6ac1">.</span>istitle(),
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;-1:word.isupper=</span><span style="color:#5af78e">%s</span><span style="color:#5af78e">&#39;</span> <span style="color:#ff6ac1">%</span> word1<span style="color:#ff6ac1">.</span>isupper(),
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;-1:word.isdigit=</span><span style="color:#5af78e">%s</span><span style="color:#5af78e">&#39;</span> <span style="color:#ff6ac1">%</span> word1<span style="color:#ff6ac1">.</span>isdigit(),
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;-1:postag=&#39;</span> <span style="color:#ff6ac1">+</span> postag1
</span></span><span style="display:flex;"><span>        ])
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#78787e"># Indicate that it is the &#39;beginning of a document&#39;</span>
</span></span><span style="display:flex;"><span>        features<span style="color:#ff6ac1">.</span>append(<span style="color:#5af78e">&#39;BOS&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#78787e"># Features for words that are not</span>
</span></span><span style="display:flex;"><span>    <span style="color:#78787e"># at the end of a document</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">if</span> i <span style="color:#ff6ac1">&lt;</span> <span style="color:#ff5c57">len</span>(doc)<span style="color:#ff6ac1">-</span><span style="color:#ff9f43">1</span>:
</span></span><span style="display:flex;"><span>        word1 <span style="color:#ff6ac1">=</span> doc[i<span style="color:#ff6ac1">+</span><span style="color:#ff9f43">1</span>][<span style="color:#ff9f43">0</span>]
</span></span><span style="display:flex;"><span>        postag1 <span style="color:#ff6ac1">=</span> doc[i<span style="color:#ff6ac1">+</span><span style="color:#ff9f43">1</span>][<span style="color:#ff9f43">1</span>]
</span></span><span style="display:flex;"><span>        features<span style="color:#ff6ac1">.</span>extend([
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;+1:word.lower=&#39;</span> <span style="color:#ff6ac1">+</span> word1<span style="color:#ff6ac1">.</span>lower(),
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;+1:word.istitle=</span><span style="color:#5af78e">%s</span><span style="color:#5af78e">&#39;</span> <span style="color:#ff6ac1">%</span> word1<span style="color:#ff6ac1">.</span>istitle(),
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;+1:word.isupper=</span><span style="color:#5af78e">%s</span><span style="color:#5af78e">&#39;</span> <span style="color:#ff6ac1">%</span> word1<span style="color:#ff6ac1">.</span>isupper(),
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;+1:word.isdigit=</span><span style="color:#5af78e">%s</span><span style="color:#5af78e">&#39;</span> <span style="color:#ff6ac1">%</span> word1<span style="color:#ff6ac1">.</span>isdigit(),
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;+1:postag=&#39;</span> <span style="color:#ff6ac1">+</span> postag1
</span></span><span style="display:flex;"><span>        ])
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#78787e"># Indicate that it is the &#39;end of a document&#39;</span>
</span></span><span style="display:flex;"><span>        features<span style="color:#ff6ac1">.</span>append(<span style="color:#5af78e">&#39;EOS&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">return</span> features
</span></span></code></pre></div><h3 id="training-the-model" >
<div>
    <a href="#training-the-model">
        ##
    </a>
    Training the Model
</div>
</h3>
<p>To train the model, we need to first prepare the training data and the corresponding labels. Also, to be able to investigate the accuracy of the model, we need to separate the data into training set and test set. Below are some codes for preparing the training data and test data, using the <a href="http://scikit-learn.org/stable/modules/generated/sklearn.model_selection.train_test_split.html"><code>train_test_split</code> function in scikit-learn</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff6ac1">from</span> sklearn.model_selection <span style="color:#ff6ac1">import</span> train_test_split
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># A function for extracting features in documents</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">def</span> <span style="color:#57c7ff">extract_features</span>(doc):
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">return</span> [word2features(doc, i) <span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">in</span> <span style="color:#ff5c57">range</span>(<span style="color:#ff5c57">len</span>(doc))]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># A function fo generating the list of labels for each document</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">def</span> <span style="color:#57c7ff">get_labels</span>(doc):
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">return</span> [label <span style="color:#ff6ac1">for</span> (token, postag, label) <span style="color:#ff6ac1">in</span> doc]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>X <span style="color:#ff6ac1">=</span> [extract_features(doc) <span style="color:#ff6ac1">for</span> doc <span style="color:#ff6ac1">in</span> data]
</span></span><span style="display:flex;"><span>y <span style="color:#ff6ac1">=</span> [get_labels(doc) <span style="color:#ff6ac1">for</span> doc <span style="color:#ff6ac1">in</span> data]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>X_train, X_test, y_train, y_test <span style="color:#ff6ac1">=</span> train_test_split(X, y, test_size<span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0.2</span>)
</span></span></code></pre></div><p>In <code>pycrfsuite</code>, A CRF model in can be trained by first creating a <strong>trainer</strong>, and then submit the training data and corresponding labels to the trainer. After that, set the parameters and call <code>train()</code> to start the training process. For the complete list of parameters, one can refer to the <a href="http://www.chokkan.org/software/crfsuite/manual.html#idp8849114176">documentation of CRFSuite</a>. With the very small dataset in this example, the training with <code>max_iterations=200</code> can be finished in a few seconds. Below is the code for creating the trainer and start training the model:</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> pycrfsuite
</span></span><span style="display:flex;"><span>trainer <span style="color:#ff6ac1">=</span> pycrfsuite<span style="color:#ff6ac1">.</span>Trainer(verbose<span style="color:#ff6ac1">=</span><span style="color:#ff6ac1">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Submit training data to the trainer</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">for</span> xseq, yseq <span style="color:#ff6ac1">in</span> <span style="color:#ff5c57">zip</span>(X_train, y_train):
</span></span><span style="display:flex;"><span>    trainer<span style="color:#ff6ac1">.</span>append(xseq, yseq)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Set the parameters of the model</span>
</span></span><span style="display:flex;"><span>trainer<span style="color:#ff6ac1">.</span>set_params({
</span></span><span style="display:flex;"><span>    <span style="color:#78787e"># coefficient for L1 penalty</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#39;c1&#39;</span>: <span style="color:#ff9f43">0.1</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#78787e"># coefficient for L2 penalty</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#39;c2&#39;</span>: <span style="color:#ff9f43">0.01</span>,  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#78787e"># maximum number of iterations</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#39;max_iterations&#39;</span>: <span style="color:#ff9f43">200</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#78787e"># whether to include transitions that</span>
</span></span><span style="display:flex;"><span>    <span style="color:#78787e"># are possible, but not observed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#39;feature.possible_transitions&#39;</span>: <span style="color:#ff6ac1">True</span>
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Provide a file name as a parameter to the train function, such that</span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># the model will be saved to the file when training is finished</span>
</span></span><span style="display:flex;"><span>trainer<span style="color:#ff6ac1">.</span>train(<span style="color:#5af78e">&#39;crf.model&#39;</span>)
</span></span></code></pre></div><p>If you have set <code>verbose=True</code> when initialising the trainer, the trainer will print out the training progress as it is trained against the provided training data.</p>
<h3 id="checking-the-results" >
<div>
    <a href="#checking-the-results">
        ##
    </a>
    Checking the Results
</div>
</h3>
<p>Once we have the model trained, we can apply it on our test data and see whether it gives reasonable results. Assuming that the model is saved to a file named <code>crf.model</code>. The following block of code shows how we can load the model into memory, and apply it on to our test data.</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>tagger <span style="color:#ff6ac1">=</span> pycrfsuite<span style="color:#ff6ac1">.</span>Tagger()
</span></span><span style="display:flex;"><span>tagger<span style="color:#ff6ac1">.</span>open(<span style="color:#5af78e">&#39;crf.model&#39;</span>)
</span></span><span style="display:flex;"><span>y_pred <span style="color:#ff6ac1">=</span> [tagger<span style="color:#ff6ac1">.</span>tag(xseq) <span style="color:#ff6ac1">for</span> xseq <span style="color:#ff6ac1">in</span> X_test]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Let&#39;s take a look at a random sample in the testing set</span>
</span></span><span style="display:flex;"><span>i <span style="color:#ff6ac1">=</span> <span style="color:#ff9f43">12</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">for</span> x, y <span style="color:#ff6ac1">in</span> <span style="color:#ff5c57">zip</span>(y_pred[i], [x[<span style="color:#ff9f43">1</span>]<span style="color:#ff6ac1">.</span>split(<span style="color:#5af78e">&#34;=&#34;</span>)[<span style="color:#ff9f43">1</span>] <span style="color:#ff6ac1">for</span> x <span style="color:#ff6ac1">in</span> X_test[i]]):
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">print</span>(<span style="color:#5af78e">&#34;</span><span style="color:#5af78e">%s</span><span style="color:#5af78e"> (</span><span style="color:#5af78e">%s</span><span style="color:#5af78e">)&#34;</span> <span style="color:#ff6ac1">%</span> (y, x))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5af78e">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">The following will be printed:
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">sci-med (N)
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">life (N)
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">systems (N)
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">inc (N)
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">said (I)
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">its (I)
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">directors (I)
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">approved (I)
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">a (I)
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">previously (I)
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">...
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">&#39;&#39;&#39;</span>
</span></span></code></pre></div><p>The result looks reasonable as the first four words are correctly identified as part of a named entity.</p>
<p>To study the performance of the CRF tagger trained above in a more quantitative way, we can check the <strong>precision</strong> and <strong>recall</strong> on the test data. This can be done very easily using the <a href="http://scikit-learn.org/stable/modules/generated/sklearn.metrics.classification_report.html"><code>classification_report</code> function in scikit-learn</a>. However, given that the predictions are sequences of tags, we need to transform the data into a list of labels before feeding them into the function.</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> numpy <span style="color:#ff6ac1">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">from</span> sklearn.metrics <span style="color:#ff6ac1">import</span> classification_report
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Create a mapping of labels to indices</span>
</span></span><span style="display:flex;"><span>labels <span style="color:#ff6ac1">=</span> {<span style="color:#5af78e">&#34;N&#34;</span>: <span style="color:#ff9f43">1</span>, <span style="color:#5af78e">&#34;I&#34;</span>: <span style="color:#ff9f43">0</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Convert the sequences of tags into a 1-dimensional array</span>
</span></span><span style="display:flex;"><span>predictions <span style="color:#ff6ac1">=</span> np<span style="color:#ff6ac1">.</span>array([labels[tag] <span style="color:#ff6ac1">for</span> row <span style="color:#ff6ac1">in</span> y_pred <span style="color:#ff6ac1">for</span> tag <span style="color:#ff6ac1">in</span> row])
</span></span><span style="display:flex;"><span>truths <span style="color:#ff6ac1">=</span> np<span style="color:#ff6ac1">.</span>array([labels[tag] <span style="color:#ff6ac1">for</span> row <span style="color:#ff6ac1">in</span> y_test <span style="color:#ff6ac1">for</span> tag <span style="color:#ff6ac1">in</span> row])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Print out the classification report</span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">print</span>(classification_report(
</span></span><span style="display:flex;"><span>    truths, predictions,
</span></span><span style="display:flex;"><span>    target_names<span style="color:#ff6ac1">=</span>[<span style="color:#5af78e">&#34;I&#34;</span>, <span style="color:#5af78e">&#34;N&#34;</span>]))
</span></span></code></pre></div><p>which will prints a report as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>              precision   recall  f1<span style="color:#ff6ac1">-</span>score   support
</span></span><span style="display:flex;"><span>          I       <span style="color:#ff9f43">0.98</span>      <span style="color:#ff9f43">0.98</span>      <span style="color:#ff9f43">0.98</span>      <span style="color:#ff9f43">3322</span>
</span></span><span style="display:flex;"><span>          N       <span style="color:#ff9f43">0.85</span>      <span style="color:#ff9f43">0.85</span>      <span style="color:#ff9f43">0.85</span>       <span style="color:#ff9f43">405</span>
</span></span><span style="display:flex;"><span>avg <span style="color:#ff6ac1">/</span> total       <span style="color:#ff9f43">0.97</span>      <span style="color:#ff9f43">0.97</span>      <span style="color:#ff9f43">0.97</span>      <span style="color:#ff9f43">3727</span>
</span></span></code></pre></div><p>We can see that we have achieved 85% precision and 85% recall in predicting whether a word is part of a named entity. There are several things by which we can improve the performance, including creating better features or tuning the parameters of the CRF model.</p>
<h3 id="source-codes" >
<div>
    <a href="#source-codes">
        ##
    </a>
    Source Codes
</div>
</h3>
<p>The source code for reproducing the above results can be found in the following github repository: <a href="https://github.com/albertauyeung/python-crf-named-entity-recognition">https://github.com/albertauyeung/python-crf-named-entity-recognition</a>.</p>
<h2 id="references" >
<div>
    <a href="#references">
        #
    </a>
    References
</div>
</h2>
<ul>
<li>Lafferty, J., McCallum, A., Pereira, F. (2001). <a href="http://repository.upenn.edu/cgi/viewcontent.cgi?article=1162&amp;context=cis_papers">&ldquo;Conditional random fields: Probabilistic models for segmenting and labeling sequence data&rdquo;</a>. Proc. 18th International Conf. on Machine Learning. Morgan Kaufmann. pp. 282‚Äì289.</li>
<li>Erdogan, H. (2010). <a href="http://www.icmla-conference.org/icmla10/CFP_Tutorial_files/hakan.pdf">Sequence Labeling: Generative and Discriminative Approaches - Hidden Markov Models, Conditional Random Fields and Structured SVMs</a>. ICMLA 2010 Tutorial.</li>
</ul>
        </div>

    </article>

    
    

    
        
        
            <h3 class="read-next-title noselect">Read next</h3>
            <ul class="read-next-posts noselect">
                
                <li><a href="/2017/04/23/python-matrix-factorization.html">üî• Matrix Factorization: A Simple Tutorial and Implementation in Python</a></li>
                
            </ul>
        
    

    

    
        









    

    

    

    

        </main>
        
            <footer class="common-footer noselect">
    
    

    <div class="common-footer-bottom">
        

        <div style="display: flex; align-items: center; gap:8px">
            ¬©  Albert Au Yeung,  2025
            
        </div>
        <div style="display:flex;align-items: center">
            
            
            
            
            
            
        </div>
        <div>
            Powered by <a target="_blank" rel="noopener noreferrer" href="https://gohugo.io/">Hugo</a>, theme <a target="_blank" rel="noopener noreferrer" href="https://github.com/Junyi-99/hugo-theme-anubis2">Anubis2</a>.<br>
            

        </div>
    </div>

    <p class="h-card vcard">

    <a href=https://ayeung.dev/ class="p-name u-url url fn" rel="me">map[location:Dublin, Ireland name:Albert Au Yeung]</a>

    

    
</p>

</footer>

        
    </div>
</body>
</html>
